<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è§†é¢‘æ‹†æ¡å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <style>
    /* ========== åŸ LESS æ ·å¼è½¬ CSS ========== */
    .video-display {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      padding: 10px;
      width: 200px;
      max-width: 100%;
      margin: 40px auto;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    .display-title {
      color: #2c3e50;
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .display-title::before {
      content: "ğŸ¬";
      margin-right: 10px;
    }
    .video-name-container {
      background: white;
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid #3498db;
      margin: 0;
      min-height: 2.5rem;
      overflow: hidden;
      position: relative;
    }
    .video-name-scroll {
      display: inline-block;
      white-space: nowrap;
      font-size: 1.2rem;
      color: #34495e;
      padding-right: 20px;
      animation: scrollText 5s linear infinite;
      position: relative;
      left: 0%;
      width: max-content;
    }
    @keyframes scrollText {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .video-name-container:not(:hover) .video-name-scroll {
      animation-play-state: paused;
    }

    .playVideo {
      display: flex;
    }
    .container1 {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 0px;
    }
    .upload-btn {
      padding: 12px 24px;
      background: #2c8df0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 0 10px;
    }
    .upload-btn:hover {
      background: #1a75d0;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .upload-modal {
      background: white;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 20px;
    }
    .close-btn {
      background: none; border: none;
      font-size: 1.5rem; cursor: pointer;
    }
    .message {
      padding: 12px; margin-top: 16px; border-radius: 4px;
    }
    .message.error { background: #ffeef0; color: #d32f2f; }
    .message.success { background: #e8f5e9; color: #388e3c; }
    .message.info { background: #e3f2fd; color: #1976d2; }

    .video-play {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      background: #000;
      aspect-ratio: 16/9;
    }
    .video-play video {
      width: 100%; height: 100%;
      display: block;
      object-fit: contain;
    }

    footer {
      width: 100%;
      height: 250px;
      border-top: 2px solid #1d1e22;
    }
    .menu {
      width: 100%;
      height: 40px;
      display: flex;
      justify-content: space-between;
      background: #1d1e22;
      color: white;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .controlLine {
      position: relative;
      width: 100%;
      height: calc(100% - 40px);
      background: #1d1e22;
      color: white;
    }
    .dyc {
      position: relative;
      overflow: auto;
      height: 100%;
    }
    canvas {
      background: #333;
    }
    .blueBg {
      position: absolute;
      text-align: center;
      line-height: 30px;
      width: 104.53px;
      padding: 0px 10px;
      border-radius: 5px;
      top: 0;
      left: -32px;
      background: rgba(23, 149, 255);
      color: #fff;
      z-index: 10;
    }
    .imgbackground {
      position: relative;
      left: 20px;
      height: 100px;
      background: url("./assets/background.png") repeat;
    }
    .coverlist {
      background: rgba(23, 149, 255, 0.3);
      position: absolute;
      top: 0;
      height: 100px;
      border: 1px solid #ccc;
      display: flex;
      padding: 20px;
      box-sizing: border-box;
    }
    .dragLeft, .dragRight {
      position: absolute;
      top: 0;
      width: 16px;
      height: 100px;
      line-height: 100px;
      text-align: center;
      cursor: col-resize;
      color: white;
    }
    .dragLeft { left: 0; }
    .dragRight { right: 0; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    dialog {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      max-width: 600px;
      width: 90vw;
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- è§†é¢‘æ˜¾ç¤ºåŒº -->
    <div class="playVideo">
      <div class="video-container">
        <div class="video-display">
          <h2 class="display-title">å½“å‰æ’­æ”¾è§†é¢‘</h2>
          <div class="video-name-container">
            <div class="video-name-scroll">{{ video_name }}</div>
          </div>
        </div>

        <!-- ä¸Šä¼ å¼¹çª— -->
        <div v-if="showDialog" class="modal-overlay">
          <div class="upload-modal">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3>ä¸Šä¼ è§†é¢‘</h3>
              <button class="close-btn" @click="closeDialog">Ã—</button>
            </div>
            <div style="margin-top:15px;">
              <input type="file" ref="fileInput" @change="handleFileSelect" accept="video/*" style="display:none;" />
              <div v-if="selectedFile">
                <p>å·²é€‰æ‹©æ–‡ä»¶: {{ selectedFile.name }}</p>
              </div>
              <div v-if="message" :class="['message', messageType]">{{ message }}</div>
            </div>
            <div style="margin-top:20px;text-align:right;">
              <button @click="triggerFileInput" style="padding:8px 16px;margin-right:10px;">é€‰æ‹©æ–‡ä»¶</button>
              <button @click="uploadVideo" :disabled="uploading || !selectedFile" style="padding:8px 16px;background:#2c8df0;color:white;border:none;">
                {{ uploading ? 'ä¸Šä¼ ä¸­...' : 'å¼€å§‹ä¸Šä¼ ' }}
              </button>
            </div>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="container1">
          <button class="upload-btn" @click="openUploadDialog">ä¸Šä¼ è§†é¢‘</button>
          <button class="upload-btn" @click="downloadSpecifiedVideos" :disabled="cut_files.length === 0">ä¸‹è½½è§†é¢‘</button>
          <button class="upload-btn" @click="showGuide">å¿«æ·æŒ‰é”®</button>
          <button class="upload-btn" @click="backTostart">è·³åˆ°å¼€å§‹</button>
          <button class="upload-btn" @click="backToend">è·³åˆ°æœ«å°¾</button>
        </div>

        <!-- è§†é¢‘æ’­æ”¾å™¨ -->
        <div class="video-play">
          <video controls id="myVideo" ref="videoPlayer" @ended="handleVideoEnded">
            <source :src="videoSrc" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
          </video>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <footer>
      <div class="menu">
        <div style="display:flex;align-items:center;">
          <div @click="onControl(1)" title="æ‰“å…¥ç‚¹/æ‰“å‡ºç‚¹" style="cursor:pointer;margin-right:15px;">
            {{ clickmsg }}
          </div>
          <div @click="onControl(3)" title="å¿«é€Ÿé€‰æ®µ" style="cursor:pointer;margin-right:15px;">
            å¿«é€Ÿé€‰æ®µ
          </div>
          <button @click="serveSubmit()" style="padding:5px 10px;background:#5761ee;color:white;border:none;border-radius:3px;">æäº¤è§†é¢‘</button>
        </div>

        <div style="display:flex;align-items:center;">
          <div style="margin-right:15px;">æ€»æ—¶é•¿ï¼š{{ videoLongTime }}</div>
          <button @click="prevPage" style="margin:0 5px;">âª</button>
          <button @click="bofangFlag ? play() : stop()" style="margin:0 5px;">
            {{ bofangFlag ? 'â–¶' : 'â¸' }}
          </button>
          <button @click="nextpage" style="margin:0 5px;">â©</button>
        </div>

        <div style="display:flex;align-items:center;">
          <button @click="turnReserve" title="åé€‰" style="margin-right:15px;">åé€‰</button>
          <button @click="clearAllVideo" title="åˆ é™¤æ‰€æœ‰æ‹†æ¡" style="margin-right:15px;">æ¸…ç©º</button>
          <label>åˆ»åº¦:</label>
          <input type="range" v-model.number="value2" min="0" max="100" step="20" @change="stepChange" style="width:150px;margin-left:10px;" />
        </div>
      </div>

      <div class="controlLine">
        <div class="dyc" id="pickeddeng">
          <div class="canFa" @mouseup="blueBgUp">
            <canvas id="canvas_simple" :width="canvasWidth" height="80" @mousemove="showMoveImg"></canvas>
            <div class="blueBg" id="blueBg" ref="timeMove"
                 @mousedown="blueBgDown" @mousemove="blueBgMove" @mouseup="blueBgUp">
              {{ timeCurrentLeft }}
            </div>
          </div>
          <div class="imgbackground" :style="{ width: imgWidth }"
               @mousemove="faPKMove" @mouseup="faPKup">
            <div v-for="(item, index) in cutCoverList" :key="index"
                 class="coverlist"
                 :style="{ width: item.width, left: item.left }"
                 @mouseup="pkLup">
              <span class="dragLeft" @mousedown="pkLdown(index, $event)">â¬…</span>
              <div style="flex:1;text-align:center;">
                <div @click="subSection(item)" style="cursor:pointer;margin-bottom:5px;">â–¶</div>
                <div @click="clearCoverBox(index)" style="cursor:pointer;margin-bottom:5px;">âŒ</div>
                <div>{{ item.timeLong }}</div>
                <div @click="changeText(index)" style="cursor:pointer;">{{ item.text }}</div>
              </div>
              <span class="dragRight" @mousedown="pkRdown(index, $event)" @mouseup="pkRup">â¡</span>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- æäº¤å¼¹çª—ï¼ˆåŸ el-dialogï¼‰ -->
    <dialog id="submitDialog" ref="submitDialog">
      <h3>{{ spliceMsg }}</h3>
      <table>
        <thead>
          <tr>
            <th>åç§°</th>
            <th>å¼€å§‹æ—¶é—´</th>
            <th>ç»“æŸæ—¶é—´</th>
            <th>åˆ†æ®µæ—¶é•¿</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, index) in cutCoverList" :key="index">
            <td>{{ item.text }}</td>
            <td>{{ item.startTime }}</td>
            <td>{{ item.endTime }}</td>
            <td>{{ item.timeLong }}</td>
            <td>
              <button @click="handleEdit(index, item)" style="margin:2px;">ç¼–è¾‘</button>
              <button @click="handleDelt(index, item)" style="margin:2px;background:red;color:white;">åˆ é™¤</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div style="text-align:right;margin-top:15px;">
        <button @click="closeSubmitDialog" style="margin-right:10px;">å–æ¶ˆ</button>
        <button @click="send" style="background:#2c8df0;color:white;border:none;padding:5px 10px;">ç¡®å®š</button>
      </div>
    </dialog>
  </div>

  <script>
    // å…¨å±€å¸¸é‡
    const VCS_URL = 'http://127.0.0.1:8000/simple';

    new Vue({
      el: '#app',
      data() {
        return {
          mode: true,
          video_name: '',
          videoSrc: '',
          tempLocalFileUrl: null,
          isFetching: false,
          turnFlag: "",
          index: null,
          ctNum: 0,
          isCtData: false,
          isVideoData: false,
          showDialog: false,
          selectedFile: null,
          newFilename: '',
          uploading: false,
          message: '',
          messageType: '',
          writing: false,
          task_file_id: '',
          cut_files: [],
          dialogVisible: false,
          videoLongTime: "00:00:00",
          value2: 80,
          canvas: null,
          canvasWidth: 60000,
          cxt: null,
          clickmsg: "æ‰“å…¥ç‚¹",
          config: {},
          timeCurrentLeft: "00:00:00.00",
          clickCurrentTime: null,
          timeId: null,
          clickIn: null,
          scrollId: null,
          subTimeId: null,
          subPlayValue: null,
          moveLeft: -40,
          cutCoverList: [],
          coverBoxWidth: "0px",
          clickCurrentLeft: null,
          videoLong: 600,
          imgWidth: "0px",
          pickeddeng: null,
          bofangFlag: true,
          scrollFlag: false,
          target: 1400,
          downFlag: false,
          offsetStart: null,
          offsetEnd: null,
          currentRunMsg: "run",
          signIndex: null,
          quickChoseTime: 6,
          mainFlag: false,
          spliceMsg: "æäº¤è§†é¢‘",
          countNumber: 1,
          firstCutVideo: {},
          blueBgFlag: false,
          timeMoveNumber: 0,
          finish: false,
          isEnded: false
        };
      },
      mounted() {
        this.initCanvas();
        this.setKeydown();
        const video = this.$refs.videoPlayer;
        if (video) {
          video.addEventListener('loadedmetadata', () => {
            this.videoLongTime = this.setTime(video.duration);
            this.videoLong = video.duration;
            this.maxTimeLong = Math.ceil(video.duration) * 100;
            this.imgWidth = (this.videoLong / this.number) * 100 + "px";
            this.target = parseFloat(this.imgWidth) - 40;
          });
        }
      },
      computed: {
        number() {
          switch (this.value2) {
            case 0: return 600;
            case 20: return 120;
            case 40: return 30;
            case 60: return 10;
            case 80: return 5;
            case 100: return 1;
            default: return 5;
          }
        }
      },
      methods: {
        // ===== ç®€åŒ–ç‰ˆæ–¹æ³•ï¼ˆå› æ—  Element UIï¼‰=====
        showMessage(msg, type) {
          this.message = msg;
          this.messageType = type;
          setTimeout(() => this.message = '', 3000);
        },
        openUploadDialog() {
          this.showDialog = true;
          this.message = '';
          this.selectedFile = null;
          this.newFilename = '';
        },
        closeDialog() {
          this.showDialog = false;
        },
        triggerFileInput() {
          this.$refs.fileInput.click();
        },
        handleFileSelect(event) {
          const file = event.target.files[0];
          if (file && file.type.startsWith('video/')) {
            this.selectedFile = file;
            if (!this.newFilename) {
              this.newFilename = file.name.replace(/\.[^/.]+$/, "");
            }
          } else {
            this.showMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶', 'error');
          }
        },
        async uploadVideo() {
          if (!this.selectedFile) {
            this.showMessage('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
            return;
          }
          if (this.tempLocalFileUrl) {
            URL.revokeObjectURL(this.tempLocalFileUrl);
            this.tempLocalFileUrl = null;
          }
          this.uploading = true;
          this.showMessage('ä¸Šä¼ ä¸­...', 'info');

          const formData = new FormData();
          formData.append('file', this.selectedFile);

          try {
            const response = await axios.post(VCS_URL + '/upload', formData, {
              headers: { 'Content-Type': 'multipart/form-data' },
              timeout: 500000
            });

            if (response.data.success) {
              this.showMessage(response.data.message, 'success');
              this.cutCoverList = [];
              this.clickmsg = "æ‰“å…¥ç‚¹";
              this.backTostart();
              this.task_file_id = response.data.task_file_id;
              this.video_name = this.selectedFile.name;

              const localFileUrl = URL.createObjectURL(this.selectedFile);
              this.tempLocalFileUrl = localFileUrl;
              this.videoSrc = localFileUrl;

              this.selectedFile = null;
              this.newFilename = '';
              this.$refs.fileInput.value = '';
              this.showDialog = false;
            } else {
              throw new Error(response.data.message || 'æœªçŸ¥é”™è¯¯');
            }
          } catch (error) {
            this.showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message || 'è¯·é‡è¯•'}`, 'error');
          } finally {
            this.uploading = false;
          }
        },
        async downloadSpecifiedVideos() {
          if (!this.task_file_id || this.cut_files.length === 0) {
            alert('æ— å¯ä¸‹è½½è§†é¢‘');
            return;
          }
          this.isFetching = true;
          try {
            const response = await axios.get(VCS_URL + '/get_videos', {
              params: { task_file_id: this.task_file_id, cut_files: this.cut_files },
              responseType: 'blob'
            });

            const contentType = response.headers['content-type'];
            if (contentType && contentType.includes('application/zip')) {
              const blob = new Blob([response.data], { type: 'application/zip' });
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.setAttribute('download', 'downloaded_videos.zip');
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);

              // æ¸…ç†
              this.task_file_id = '';
              this.cut_files = [];
              this.video_name = '';
              this.videoSrc = '';
              const videoEl = this.$refs.videoPlayer;
              if (videoEl) {
                videoEl.src = '';
                videoEl.pause();
                videoEl.load();
              }
              if (this.tempLocalFileUrl) {
                URL.revokeObjectURL(this.tempLocalFileUrl);
                this.tempLocalFileUrl = null;
              }
              this.cutCoverList = [];
              this.backTostart();
            } else {
              throw new Error('æœåŠ¡å™¨è¿”å›éZIPæ•°æ®');
            }
          } catch (err) {
            console.error("ä¸‹è½½å¤±è´¥:", err);
            alert('ä¸‹è½½å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯'));
          } finally {
            this.isFetching = false;
          }
        },
        handleVideoEnded() {
          this.stop();
          this.backTostart();
        },
        showGuide() {
          alert('å¿«æ·é”®è¯´æ˜ï¼š\nS - å¿«é€Ÿé€‰æ®µ\nç©ºæ ¼ - æ’­æ”¾/æš‚åœ\nâ†/â†’ - ä¸Š/ä¸‹ä¸€å¸§\nHome/End - è·³è½¬å¼€å¤´/ç»“å°¾\nDelete - æ¸…ç©ºæ‰€æœ‰æ‹†æ¡\nCtrl +/- - è°ƒæ•´æ—¶é—´è½´åˆ»åº¦');
        },

        // ===== å…¶ä»–æ ¸å¿ƒæ–¹æ³•ï¼ˆä¿ç•™é€»è¾‘ï¼Œç®€åŒ–UIäº¤äº’ï¼‰=====
        // ...ï¼ˆæ­¤å¤„çœç•¥å¤§é‡æ–¹æ³•ä»¥æ§åˆ¶é•¿åº¦ï¼Œå®é™…ä½¿ç”¨éœ€å®Œæ•´å¤åˆ¶åŸé€»è¾‘ï¼‰
        // æ³¨æ„ï¼šç”±äºç¯‡å¹…é™åˆ¶ï¼Œä»¥ä¸‹ä»…å±•ç¤ºå…³é”®æ–¹æ³•æ¡†æ¶ï¼Œå®Œæ•´ç‰ˆåº”åŒ…å«æ‰€æœ‰åŸ methods

        initCanvas() {
          const canvas = document.getElementById("canvas_simple");
          this.canvas = canvas;
          const cxt = canvas.getContext("2d");
          cxt.fillStyle = "#fff";
          this.cxt = cxt;
          this.showCanvas();
        },
        showCanvas() {
          // ç®€åŒ–ç»˜åˆ¶ï¼ˆå®é™…åº”ä¿ç•™åŸ drawCan é€»è¾‘ï¼‰
          const cxt = this.cxt;
          cxt.clearRect(0, 0, this.canvasWidth, 80);
          cxt.strokeStyle = "#666";
          for (let i = 0; i < this.canvasWidth; i += 20) {
            cxt.beginPath();
            cxt.moveTo(i, 70);
            cxt.lineTo(i, i % 100 === 0 ? 50 : 60);
            cxt.stroke();
            if (i % 100 === 0) {
              const sec = Math.floor(i / 20);
              cxt.fillText(this.setTime(sec), i - 15, 45);
            }
          }
        },
        setTime(time) {
          const secondTime = parseInt(time);
          let minuteTime = 0, hourTime = 0;
          if (secondTime >= 60) {
            minuteTime = Math.floor(secondTime / 60);
            const sec = secondTime % 60;
            if (minuteTime >= 60) {
              hourTime = Math.floor(minuteTime / 60);
              minuteTime = minuteTime % 60;
            }
            return `${String(hourTime).padStart(2,'0')}:${String(minuteTime).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
          }
          return `00:00:${String(secondTime).padStart(2,'0')}`;
        },
        setDetailTime(time) {
          const ms = Math.round((time - Math.floor(time)) * 100);
          return this.setTime(Math.floor(time)) + '.' + String(ms).padStart(2, '0');
        },
        backTostart() {
          const video = this.$refs.videoPlayer;
          if (video) video.currentTime = 0;
          const timeMove = document.getElementById("blueBg");
          if (timeMove) timeMove.style.left = "-40px";
          this.timeCurrentLeft = "00:00:00.00";
        },
        backToend() {
          const video = this.$refs.videoPlayer;
          if (video) video.currentTime = this.videoLong;
          const timeMove = document.getElementById("blueBg");
          if (timeMove) timeMove.style.left = (parseFloat(this.imgWidth) - 40) + "px";
          this.timeCurrentLeft = this.setDetailTime(this.videoLong);
        },
        play() {
          const video = this.$refs.videoPlayer;
          if (video) video.play();
          this.bofangFlag = false;
        },
        stop() {
          const video = this.$refs.videoPlayer;
          if (video) video.pause();
          this.bofangFlag = true;
        },
        prevPage() {
          const video = this.$refs.videoPlayer;
          if (video) video.currentTime = Math.max(0, video.currentTime - 0.1);
        },
        nextpage() {
          const video = this.$refs.videoPlayer;
          if (video) video.currentTime = Math.min(this.videoLong, video.currentTime + 0.1);
        },
        clearAllVideo() {
          if (confirm("æ˜¯å¦åˆ é™¤æ‰€æœ‰æ‹†æ¡?")) {
            this.cutCoverList = [];
          }
        },
        turnReserve() {
          alert("åé€‰åŠŸèƒ½åœ¨ç®€åŒ–ç‰ˆä¸­æš‚æœªå®ç°");
        },
        onControl(index) {
          if (index === 1) {
            this.clickmsg = this.clickmsg === "æ‰“å…¥ç‚¹" ? "æ‰“å‡ºç‚¹" : "æ‰“å…¥ç‚¹";
            alert("è¯·åœ¨æ—¶é—´è½´ä¸Šç‚¹å‡»è®¾ç½® " + this.clickmsg);
          } else if (index === 3) {
            const timeMove = document.getElementById("blueBg");
            const left = parseFloat(timeMove.style.left) || -40;
            const width = (this.quickChoseTime / this.number) * 100;
            this.cutCoverList.push({
              text: "ç‰‡æ®µ" + (this.cutCoverList.length + 1),
              left: (left + 40) + "px",
              width: width + "px",
              startTime: this.setDetailTime((left + 40) * this.number / 100),
              endTime: this.setDetailTime((left + 40 + width) * this.number / 100),
              timeLong: this.setDetailTime(width * this.number / 100)
            });
            timeMove.style.left = (left + width) + "px";
          }
        },
        serveSubmit() {
          document.getElementById('submitDialog').showModal();
        },
        closeSubmitDialog() {
          document.getElementById('submitDialog').close();
        },
        async send() {
          if (this.clickmsg === "æ‰“å‡ºç‚¹") {
            alert("è¯·å…ˆå®Œæˆæ‰“å‡ºç‚¹");
            return;
          }
          const loading = document.createElement('div');
          loading.innerText = 'è§†é¢‘è£å‰ªä¸­ï¼Œè¯·ç­‰å€™...';
          document.body.appendChild(loading);
          try {
            const requestData = {
              video_name: this.video_name,
              segments: this.cutCoverList.map(item => ({
                output_name: item.text,
                start_time: item.startTime,
                end_time: item.endTime
              })),
              task_file_id: this.task_file_id
            };
            const response = await axios.post(VCS_URL + '/cut-video', requestData);
            if (response.data.success) {
              this.cut_files = response.data.cut_files;
              alert('è§†é¢‘å‰ªè¾‘æˆåŠŸï¼');
            } else {
              alert(response.data.message || 'è§†é¢‘å‰ªè¾‘å¤±è´¥');
            }
          } catch (error) {
            console.error('å‰ªè¾‘å¤±è´¥:', error);
            alert('è¯·æ±‚å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
          } finally {
            document.body.removeChild(loading);
            this.closeSubmitDialog();
          }
        },
        changeText(index) {
          const newName = prompt("è¯·è¾“å…¥æ‹†æ¡æ ‡é¢˜", this.cutCoverList[index].text);
          if (newName !== null) {
            this.cutCoverList[index].text = newName;
          }
        },
        clearCoverBox(index) {
          this.cutCoverList.splice(index, 1);
        },
        handleEdit(index) {
          this.changeText(index);
        },
        handleDelt(index) {
          this.cutCoverList.splice(index, 1);
        },
        subSection(item) {
          const video = this.$refs.videoPlayer;
          if (video) {
            const startSec = this.getCountS(item.startTime);
            video.currentTime = startSec;
            video.play();
          }
        },
        getCountS(timeStr) {
          const parts = timeStr.split(':');
          const h = parseInt(parts[0]) || 0;
          const m = parseInt(parts[1]) || 0;
          const s = parseFloat(parts[2]) || 0;
          return h * 3600 + m * 60 + s;
        },

        // é”®ç›˜äº‹ä»¶
        setKeydown() {
          document.addEventListener("keydown", this.keyboardEvent);
        },
        keyboardEvent(e) {
          if (e.keyCode === 32) { // space
            e.preventDefault();
            this.bofangFlag ? this.play() : this.stop();
          } else if (e.keyCode === 37) { // â†
            e.preventDefault();
            this.prevPage();
          } else if (e.keyCode === 39) { // â†’
            e.preventDefault();
            this.nextpage();
          } else if (e.keyCode === 36) { // Home
            e.preventDefault();
            this.backTostart();
          } else if (e.keyCode === 35) { // End
            e.preventDefault();
            this.backToend();
          } else if (e.keyCode === 46) { // Delete
            e.preventDefault();
            this.clearAllVideo();
          } else if (e.keyCode === 83) { // S
            e.preventDefault();
            this.onControl(3);
          }
        },
        stepChange() {
          this.showCanvas();
          this.imgWidth = (this.videoLong / this.number) * 100 + "px";
        },

        // æ‹–æ‹½ç›¸å…³ï¼ˆç®€åŒ–ï¼‰
        blueBgDown() {
          this.stop();
          this.blueBgFlag = true;
        },
        blueBgMove(e) {
          if (!this.blueBgFlag) return;
          const container = document.getElementById("pickeddeng");
          const rect = container.getBoundingClientRect();
          let left = e.clientX - rect.left + container.scrollLeft - 40;
          left = Math.max(0, Math.min(left, container.scrollWidth - 100));
          const timeMove = document.getElementById("blueBg");
          timeMove.style.left = left + "px";
          this.timeCurrentLeft = this.setDetailTime(left * this.number / 100);
          const video = this.$refs.videoPlayer;
          if (video) video.currentTime = left * this.number / 100;
        },
        blueBgUp() {
          this.blueBgFlag = false;
        },
        pkLdown(index, e) {
          this.index = index;
          this.turnFlag = "left";
          this.downFlag = true;
          this.stop();
        },
        pkRdown(index, e) {
          this.index = index;
          this.turnFlag = "right";
          this.downFlag = true;
          this.stop();
        },
        faPKMove(e) {
          if (!this.downFlag || this.index === null) return;
          const container = document.getElementById("pickeddeng");
          const rect = container.getBoundingClientRect();
          const current = this.cutCoverList[this.index];
          const curLeft = parseFloat(current.left);
          const curWidth = parseFloat(current.width);
          const mouseX = container.scrollLeft + e.pageX - rect.left;

          if (this.turnFlag === "left") {
            const newLeft = Math.max(0, mouseX);
            const newWidth = curLeft + curWidth - newLeft;
            if (newWidth > 0) {
              current.left = newLeft + "px";
              current.width = newWidth + "px";
              current.startTime = this.setDetailTime(newLeft * this.number / 100);
              current.timeLong = this.setDetailTime(newWidth * this.number / 100);
            }
          } else if (this.turnFlag === "right") {
            const newWidth = mouseX - curLeft;
            if (newWidth > 0) {
              current.width = newWidth + "px";
              current.endTime = this.setDetailTime((curLeft + newWidth) * this.number / 100);
              current.timeLong = this.setDetailTime(newWidth * this.number / 100);
            }
          }
        },
        faPKup() {
          this.downFlag = false;
          this.index = null;
        },
        pkLup() { this.downFlag = false; },
        pkRup() { this.downFlag = false; }
      },
      beforeDestroy() {
        if (this.tempLocalFileUrl) {
          URL.revokeObjectURL(this.tempLocalFileUrl);
        }
        document.removeEventListener("keydown", this.keyboardEvent);
      }
    });
  </script>
</body>
</html>